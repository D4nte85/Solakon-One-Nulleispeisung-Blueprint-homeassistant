blueprint:
  name: Solakon ONE Nulleinspeisung (DE) - Dynamisch & SOC-Gesteuert (V204)
  description: |
    **Detaillierte Funktionsbeschreibung: Dynamische Nulleinspeisung mit SOC-Zonenlogik**

    Dieser Home Assistant Blueprint implementiert eine **dynamische Nulleinspeisung** fÃ¼r den Solakon ONE Wechselrichter. Er nutzt einen **PI-Regler (Proportional-Integral-Regler)** zur prÃ¤zisen Steuerung der AC-Ausgangsleistung und eine **dreistufige State-of-Charge (SOC)-Logik** zur effizienten Verwaltung des Batteriespeichers.

    ---
    ### ðŸ§  PI-Regler & Steuerlogik
    Der Kern des Blueprints ist ein **PI-Regler (Proportional-Integral-Regler)**, der das **AC-Output-Limit** (Entladeleistung) dynamisch anpasst.
    
    * **Messprinzip:** Die Regelung basiert auf dem **Shelly/Netzleistungssensor**. **WICHTIG:** Positive Werte = Bezug, NEGATIVE WERTE = Einspeisung.
    
    * **P-Anteil (Proportional):** Reagiert auf die aktuelle Abweichung mit konfigurierbarer AggressivitÃ¤t (Regelungs-Faktor).
    
    * **I-Anteil (Integral):** Summiert Abweichungen Ã¼ber die Zeit auf und eliminiert bleibende Regelabweichungen. Wird bei Zonenwechseln zurÃ¼ckgesetzt (Anti-Windup).
    
    * **Leistungsbegrenzung:** Gesichert durch ein **oberes Hard Limit** und ein **hartkodiertes unteres Limit von 0 W**.

    ---
    ### ðŸ”‹ Dreistufige SOC-Zonenlogik
    Die Logik unterteilt den Batterieladestand (SOC) in drei Zonen:

    #### 1. Zone: Aggressive Regelung (Entladezyklus / Hoher SOC)
    * **Bedingung:** SOC > **Oberer Schwellenwert** (`soc_fast_limit`) **ODER** Entladezyklus aktiv.
    * **Aktion:** **Max. Entladestrom** wird auf den Standardwert (z.B. 40 A) gesetzt.
    * **Regelung:** PI-Regler mit **Nullpunkt-Offset von 0 W** zur exakten Nulleinspeisung.
    * **Verhalten:** Einmal aktiviert, lÃ¤uft Zone 1 bis SOC â‰¤ 20% fÃ¤llt (kein Yo-Yo-Effekt).

    #### 2. Zone: Batterieschonende Regelung (Zwischen-SOC)
    * **Bedingung:** SOC zwischen Unterer (`soc_conservation_limit`) und Oberer Schwelle, UND Entladezyklus inaktiv.
    * **Aktion:** **Max. Entladestrom** wird auf **0 A** gesetzt (Entnahme nur Ã¼ber AC-Limit).
    * **Regelung:** PI-Regler mit **Nullpunkt-Offset** (z.B. 30 W) zur Verschiebung des Regelziels hin zu leichtem **Netzbezug** (Laden).
    * **Dynamische Obergrenze:** Entladeleistung wird durch **Max(0, PV - Reserve)** gedeckelt.
    * **Nachtabschaltung:** Optional kann Zone 2 bei PV < Schwelle deaktiviert werden (Zone 1 bleibt aktiv).

    #### 3. Zone: Sicherheits-Stopp (Niedriger SOC)
    * **Bedingung:** SOC fÃ¤llt auf oder unter den **Unteren Schwellenwert**.
    * **Aktion:** Sofortiges Umschalten auf **"Disabled"** und Setzen des **AC-Output-Limits auf 0 W**.

    ---
    ### âš™ï¸ ZusÃ¤tzliche Steuermechanismen
    * **Zwei-Stufen-Moduswechsel:** Eine Puls-Sequenz (10s Puls, dann 3599s) wird verwendet, um die Modus-Kommandos zu sichern.
    * **Timeout-Refresh:** Der Remote Timeout wird automatisch auf 3599s zurÃ¼ckgesetzt, wenn der Countdown unter 120s fÃ¤llt.
    * **Integral-Reset:** Bei jedem Zonenwechsel wird der I-Anteil auf 0 zurÃ¼ckgesetzt, um Windup zu verhindern.
    * **Anti-Windup:** Der Integral-Wert ist auf Â±1000 Punkte begrenzt.
      
  domain: automation
  source_url: https://github.com/D4nte85/Solakon-One-Nulleinspeisung-Blueprint-homeassistant/edit/main/solakon_one_nulleinspeisung.yaml
  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”Œ NETZ-SENSOR (Extern - z.B. Shelly 3EM)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    grid_power_sensor:
      name: ðŸ”Œ Shelly/Netz-Leistungssensor (ERFORDERLICH)
      description: |
        Sensor fÃ¼r die aktuelle Netzleistung (z.B. Shelly 3EM).
        âš ï¸ WICHTIG: Positive Werte = Bezug, NEGATIVE WERTE = Einspeisung.
      selector:
        entity:
          domain: sensor
          device_class: power
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âš¡ SOLAKON ONE - ENTITÃ„TEN
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    solar_power_sensor:
      name: â˜€ï¸ Solakon ONE - Solarleistung (PV-Erzeugung)
      description: Die aktuelle PV-Gesamterzeugung in Watt.
      default: sensor.solakon_one_total_pv_power
      selector:
        entity:
          domain: sensor
          device_class: power
    
    soc_sensor:
      name: ðŸ”‹ Solakon ONE - Batterieladestand (SOC)
      description: Der aktuelle Batterieladestand in %.
      default: sensor.solakon_one_battery_soc
      selector:
        entity:
          domain: sensor
          device_class: battery
    
    remote_timeout_countdown_sensor:
      name: â±ï¸ Solakon ONE - Remote Timeout Countdown
      description: Sensor, der den verbleibenden Timeout-Countdown anzeigt.
      default: sensor.solakon_one_remote_timeout_countdown
      selector:
        entity:
          domain: sensor
    
    active_power_number:
      name: âš™ï¸ Solakon ONE - Ausgangsleistungsregler
      description: Die EntitÃ¤t zum Setzen des Leistungs-Sollwerts (Remote Active Power).
      default: number.solakon_one_remote_active_power
      selector:
        entity:
          domain: number
    
    max_discharge_current_number:
      name: ðŸ”‹ Solakon ONE - Max. Entladestrom
      description: Die EntitÃ¤t zur Steuerung des maximalen Entladestroms (A).
      default: number.solakon_one_battery_max_discharge_current
      selector:
        entity:
          domain: number
    
    remote_timeout_set_number:
      name: â²ï¸ Solakon ONE - Modus-Reset-Timer
      description: Dient zum Setzen/ZurÃ¼cksetzen des Remote-Timeouts (max. 3599 s).
      default: number.solakon_one_remote_timeout_set
      selector:
        entity:
          domain: number
    
    mode_select:
      name: ðŸ”„ Solakon ONE - Betriebsmodus-Auswahl
      description: Die EntitÃ¤t zum Umschalten des Betriebsmodus (Remote Control Mode).
      default: select.solakon_one_remote_control_mode
      selector:
        entity:
          domain: select
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ› ï¸ HOME ASSISTANT HELPER (ERFORDERLICH!)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    cycle_active_input_select:
      name: ðŸ› ï¸ Entladezyklus-Zustandsspeicher (input_select - ERFORDERLICH!)
      description: |
        âš ï¸ WICHTIG: Erstellen Sie einen Input Select Helfer mit den Optionen 'on' und 'off'.
        Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Dropdown
        - Name: z.B. 'SOC Entladezyklus Status'
        - Options: 'on' und 'off' (exakt so!)
        
        Dieser speichert, ob der Entladezyklus aktiv ist (Zone 1).
      default: input_select.soc_entladezyklus_status
      selector:
        entity:
          domain: input_select
    
    integral_helper:
      name: ðŸ› ï¸ Integral-Speicher (input_number - ERFORDERLICH!)
      description: |
        âš ï¸ WICHTIG: Erstellen Sie einen input_number Helper fÃ¼r den PI-Regler:
        Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Number
        - Name: z.B. 'Solakon Integral'
        - Min: -1000
        - Max: 1000
        - Step: 1
        - Initial: 0
        
        Dieser speichert den I-Anteil des PI-Reglers.
      default: input_number.solakon_integral
      selector:
        entity:
          domain: input_number
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŽšï¸ REGELUNGS-PARAMETER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    regulator_factor:
      name: ðŸŽ›ï¸ P-Faktor (Proportional-VerstÃ¤rkung)
      description: |
        P-Anteil des PI-Reglers: Reagiert auf aktuelle Abweichung (z.B. 1.5).
        HÃ¶her = schnellere, aggressivere Reaktion | Niedriger = sanftere Reaktion
      default: 1.5
      selector:
        number:
          min: 0.1
          max: 5
          step: 0.1
    
    ki_factor:
      name: ðŸŽ›ï¸ I-Faktor (Integral-VerstÃ¤rkung)
      description: |
        I-Anteil des PI-Reglers: Eliminiert bleibende Abweichungen (z.B. 0.05).
        HÃ¶her = schnellere Korrektur, aber instabiler | Niedriger = langsamer, stabiler
      default: 0.05
      selector:
        number:
          min: 0.01
          max: 0.2
          step: 0.01
    
    tolerance:
      name: ðŸ“ Toleranzbereich (Totband)
      description: |
        Bereich in Watt um den Nullpunkt, in dem KEINE Korrektur stattfindet (z.B. Â±25 W).
        Verhindert permanente Mini-Korrekturen bei stabiler Regelung.
      default: 25
      selector:
        number:
          min: 0
          max: 200
          unit_of_measurement: W
    
    wait_time:
      name: â±ï¸ Wartezeit nach setzen des Ausgangs
      description: |
        Zeit (in Sekunden) die nach Setzten des Ausgangs gewartet wird das alle wichtigen Sensoren (Netz und Solakon) aktualisieren kÃ¶nnen.
      default: 3
      selector:
        number:
          min: 0
          max: 30
          step: 1
          unit_of_measurement: s
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”‹ SOC-ZONEN-PARAMETER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    soc_fast_limit:
      name: ðŸ”‹ SOC-Schwelle "Zone 1 Start" (Aggressive Entladung)
      description: |
        Obere Schwelle (z.B. 50 %).
        Ãœberschreiten aktiviert Zone 1 (aggressive Entladung mit 40A).
        Zone 1 lÃ¤uft dann bis SOC â‰¤ 20% fÃ¤llt (kein Yo-Yo-Effekt).
      default: 50
      selector:
        number:
          min: 1
          max: 99
          unit_of_measurement: "%"
    
    soc_conservation_limit:
      name: ðŸ”‹ SOC-Schwelle "Zone 3 Stopp" (Sicherheits-Grenze)
      description: |
        Untere Schwelle (z.B. 20 %).
        Unterschreiten stoppt die Entladung komplett (Zone 3 = Disabled).
      default: 20
      selector:
        number:
          min: 1
          max: 49
          unit_of_measurement: "%"
    
    default_discharge_current:
      name: ðŸ”‹ Max. Entladestrom in Zone 1 (Ampere)
      description: |
        Maximaler Entladestrom in Zone 1 (aggressive Entladung, z.B. 40 A).
        In Zone 2 wird automatisch 0 A gesetzt (batterieschonend).
      default: 40
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: A
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âš™ï¸ ZONE 2 - PARAMETER (Batterieschonender Modus)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    offset:
      name: âš™ï¸ Zone 2 - Nullpunkt-Offset (Regelziel)
      description: |
        Zielwert fÃ¼r Netzleistung in Zone 2 (z.B. 30 W).
        Positiver Wert = leichter Netzbezug erwÃ¼nscht â†’ Batterie wird geladen.
        0 W = Exakte Nulleinspeisung (wie Zone 1).
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: W
    
    pv_charge_reserve:
      name: âš™ï¸ Zone 2 - PV-Ladereserve
      description: |
        PV-Leistung, die in Zone 2 fÃ¼r Ladung reserviert wird (z.B. 50 W).
        Dynamische Obergrenze: Max. Entladung = PV - Reserve.
        Stellt sicher, dass Batterie auch bei Trickle-Charge geladen wird.
      default: 50
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: W
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”’ SICHERHEITS-PARAMETER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    max_active_power_limit:
      name: ðŸ”’ Maximale Ausgangsleistung (Hard Limit)
      description: |
        Absolute Obergrenze der AC-Ausgangsleistung (z.B. 800 W).
        SchÃ¼tzt vor Ãœberlastung des Wechselrichters.
      default: 800
      selector:
        number:
          min: 0
          max: 1200
          unit_of_measurement: W
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ™ NACHTABSCHALTUNG (Optional)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    night_shutdown_enabled:
      name: ðŸŒ™ Nachtabschaltung aktivieren
      description: |
        Deaktiviert Zone 2 nachts automatisch (bei PV < Schwelle).
        âš ï¸ Zone 1 (aggressive Entladung) lÃ¤uft auch nachts weiter!
        Sinnvoll fÃ¼r Batterieschonung bei 0 PV.
      default: false
      selector:
        boolean:
    
    night_shutdown_pv_threshold:
      name: ðŸŒ™ PV-Schwelle fÃ¼r "Nacht"
      description: |
        Unterhalb dieser PV-Leistung gilt es als Nacht (z.B. 10 W).
        Nur relevant wenn Nachtabschaltung aktiviert ist.
      default: 10
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: W
    
mode: queued
max_exceeded: silent

variables:
  # ===========================================
  # BLOCK 1: Variablen fÃ¼r Conditions & Modus-Logik
  # (Werden IMMER benÃ¶tigt)
  # ===========================================
  
  # Zonen-Schwellwerte
  soc_fast_limit_int: !input soc_fast_limit
  soc_conservation_limit_int: !input soc_conservation_limit
  
  # Aktuelle Sensorwerte fÃ¼r Conditions
  soc: !input soc_sensor
  timeout_countdown: !input remote_timeout_countdown_sensor
  solakon_mode: !input mode_select
  cycle_active: !input cycle_active_input_select
  
  # Nachtabschaltung Config
  night_shutdown_enabled_bool: !input night_shutdown_enabled
  night_pv_threshold: !input night_shutdown_pv_threshold
  solar_power_for_night_check: !input solar_power_sensor
  
  # PI-Regler Helper
  integral_entity: !input integral_helper
  
  # EntitÃ¤ten
  active_power_entity: !input active_power_number
  discharge_current_entity: !input max_discharge_current_number
  timeout_set_entity: !input remote_timeout_set_number
  
  # Parameter
  discharge_current_max: !input default_discharge_current

trigger:
  # -------------------------------------------------------------------------------------------------
  # 1. LeistungsÃ¤nderungen (Ohne VerzÃ¶gerung fÃ¼r schnelle PI-Regelung)
  # -------------------------------------------------------------------------------------------------
  - platform: state
    entity_id: !input grid_power_sensor
    id: grid_power_change

  - platform: state
    entity_id: !input solar_power_sensor
    id: solar_power_change

  # -------------------------------------------------------------------------------------------------
  # 2. SOC-Schwellwert-Erreichung (Steuert Zonen-Wechsel)
  # -------------------------------------------------------------------------------------------------
  - platform: numeric_state
    entity_id: !input soc_sensor
    above: !input soc_fast_limit
    id: soc_high

  - platform: numeric_state
    entity_id: !input soc_sensor
    below: !input soc_conservation_limit
    id: soc_low

  # -------------------------------------------------------------------------------------------------
  # 3. Modus-Wechsel (Reagiert auf manuelle/externe Ã„nderung)
  # -------------------------------------------------------------------------------------------------
  - platform: state
    entity_id: !input mode_select
    id: mode_change

action:
  # -------------------------------------------------------------------------------------------------
  # VALIDIERUNG: Check auf kritische Fehler (Werte und EntitÃ¤ten)
  # -------------------------------------------------------------------------------------------------
  - choose:
    # PRÃœFUNG A: SOC-Limits
    - conditions:
        - condition: template
          value_template: "{{ soc_fast_limit_int <= soc_conservation_limit_int }}"
      sequence:
        - service: system_log.write
          data:
            level: error
            message: "Solakon ONE Blueprint Fehler Die obere SOC-Schwelle ({{ soc_fast_limit_int }}%) muss grÃ¶ÃŸer sein als die untere SOC-Schwelle ({{ soc_conservation_limit_int }}%). Automatisierung gestoppt."
        - stop: Die SOC-Limits sind falsch gesetzt.
          
    # PRÃœFUNG B: Kritische EntitÃ¤ten verfÃ¼gbar
    - conditions:
        - condition: or
          conditions:
            # SOC und Timeout-Countdown: PrÃ¼fe direkt auf 'unknown'/'unavailable'
            - condition: template
              value_template: >
                {{ is_state(soc, 'unknown') or is_state(soc, 'unavailable') or
                   is_state(timeout_countdown, 'unknown') or is_state(timeout_countdown, 'unavailable') }}
            # Grid Power: Wird spÃ¤ter geprÃ¼ft (nach Variables)
            # Modus-Selektor
            - condition: template
              value_template: "{{ is_state(solakon_mode, 'unknown') or is_state(solakon_mode, 'unavailable') }}"
            # Active Power Number
            - condition: template
              value_template: "{{ state_attr(active_power_entity, 'min') is none }}"
      sequence:
        - service: system_log.write
          data:
            level: error
            message: "Solakon ONE Blueprint Fehler Eine oder mehrere kritische EntitÃ¤ten (SOC, Timeout-Sensor, Ausgangsleistungsregler) sind UNVERFÃœGBAR oder haben ungÃ¼ltige Werte. Automatisierung gestoppt."
        - stop: Kritische EntitÃ¤ten sind fehlerhaft.
          
    default:
      # -------------------------------------------------------------------------------------------------
      # HAUPT-LOGIK: Modus- und Zyklus-Steuerung (Zone 1, 2, 3)
      # -------------------------------------------------------------------------------------------------
      - choose:
          # FALL A: ZONE 1 - Aggressive Entladung START (SOC > Obere Schwelle UND Zyklus OFF)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) > soc_fast_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zonenwechsel
                  message: "ðŸ”‹ Zone 1 aktiviert (Aggressive Entladung) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Integral zurÃ¼cksetzen bei Zonenwechsel
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # 1. Zyklus auf 'on' setzen
              - service: input_select.select_option
                data:
                  entity_id: !input cycle_active_input_select
                  option: 'on'
              # 2. Modus-Wechsel zu 'INV Discharge PV Priority' (mit Puls-Sequenz zur Sicherheit)
              - choose:
                  - conditions: "{{ states(solakon_mode) != 'INV Discharge (PV Priority)' }}"
                    sequence:
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 10
                      - delay: '00:00:01' 
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 3599
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: 'INV Discharge (PV Priority)'
          
          # FALL B: ZONE 3 - Sicherheits-STOPP (SOC <= Untere Schwelle UND Zyklus ON)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) <= soc_conservation_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'on'
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zonenwechsel
                  message: "ðŸ›‘ Zone 3 aktiviert (Sicherheits-Stopp) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Integral zurÃ¼cksetzen
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # 1. Zyklus auf 'off' setzen
              - service: input_select.select_option
                data:
                  entity_id: !input cycle_active_input_select
                  option: 'off'
              # 2. Modus-Wechsel zu 'Disabled'
              - choose:
                  - conditions: "{{ states(solakon_mode) != 'Disabled' }}"
                    sequence:
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: 'Disabled'
              # 3. Power Limit auf 0 W setzen (Soft Stopp)
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                  
          # FALL C: ZONE 3 - Sicherheits-STOPP (ZusÃ¤tzliche Absicherung, falls Zyklus bereits OFF aber Modus aktiv)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) < soc_conservation_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              - condition: template
                value_template: "{{ states(solakon_mode) != 'INV Discharge (PV Priority)' }}"
            sequence:
              # Modus auf 'Disabled' setzen
              - choose:
                  - conditions: "{{ states(solakon_mode) != 'Disabled' }}"
                    sequence:
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: 'Disabled'
              # Power Limit auf 0 W setzen
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                  
          # FALL D: ZONE 2 - Batterieschonend START (P-Regler aktiv, aber 0 A Entladung)
          - conditions:
              - condition: template
                value_template: "{{ states(soc) | float(0) > soc_conservation_limit_int and states(soc) | float(0) <= soc_fast_limit_int }}"
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              - condition: template
                value_template: "{{ states(solakon_mode) != 'INV Discharge (PV Priority)' }}"
              # Nachtcheck: Nur starten wenn NICHT Nacht ODER Funktion deaktiviert
              - condition: template
                value_template: >
                  {{ not night_shutdown_enabled_bool or 
                     (states(solar_power_for_night_check) | float(0)) >= night_pv_threshold }}
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Zonenwechsel
                  message: "ðŸ”‹ Zone 2 aktiviert (Batterieschonend) - SOC: {{ states(soc) }}%"
                  entity_id: !input soc_sensor
              # Integral zurÃ¼cksetzen bei Zonenwechsel
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # Modus-Wechsel zu 'INV Discharge PV Priority'
              - choose:
                  - conditions: "{{ states(solakon_mode) != 'INV Discharge (PV Priority)' }}"
                    sequence:
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 10
                      - delay: '00:00:01'
                      - service: number.set_value
                        data:
                          entity_id: !input remote_timeout_set_number
                          value: 3599
                      - service: select.select_option
                        data:
                          entity_id: !input mode_select
                          option: 'INV Discharge (PV Priority)'
          
          - conditions:
              # Nachtabschaltung aktiviert
              - condition: template
                value_template: "{{ night_shutdown_enabled_bool }}"
              # Es ist Nacht (PV unter Schwelle)
              - condition: template
                value_template: "{{ (states(solar_power_for_night_check) | float(0)) < night_pv_threshold }}"
              # Nur in Zone 2 (cycle = off)
              - condition: state
                entity_id: !input cycle_active_input_select
                state: 'off'
              # Modus ist aktuell aktiv
              - condition: template
                value_template: "{{ states(solakon_mode) == 'INV Discharge (PV Priority)' }}"
            sequence:
              # Logging
              - service: logbook.log
                data:
                  name: Solakon Nachtmodus
                  message: "ðŸŒ™ Nachtabschaltung aktiviert (Zone 2) - PV: {{ states(solar_power_for_night_check) }}W"
                  entity_id: !input solar_power_sensor
              # Integral zurÃ¼cksetzen
              - service: input_number.set_value
                data:
                  entity_id: !input integral_helper
                  value: 0
              # Modus auf 'Disabled' setzen
              - service: select.select_option
                data:
                  entity_id: !input mode_select
                  option: 'Disabled'
              # Power Limit auf 0 W
              - service: number.set_value
                data:
                  entity_id: !input active_power_number
                  value: 0
                          
  # -------------------------------------------------------------------------------------------------
  # AKTION E: PI-Regler Logik, Timeout-Refresh UND Entlade-Limit-Absicherung
  # NUR ausfÃ¼hren wenn Modus aktiv ist UND (Zone 1 ODER Tag)!
  # -------------------------------------------------------------------------------------------------
  - condition: template
    value_template: >
      {{ states(solakon_mode) == 'INV Discharge (PV Priority)' and
         (is_state(cycle_active, 'on') or 
          not night_shutdown_enabled_bool or
          (states(solar_power_for_night_check) | float(0)) >= night_pv_threshold) }}
    
  # ===========================================
  # BLOCK 2: Variablen NUR fÃ¼r PI-Regler
  # (Werden nur bei aktivem Modus berechnet)
  # ===========================================
  - variables:
      # Grid Power
      grid_power: !input grid_power_sensor
      grid_power_float: "{{ states(grid_power) | float(0) }}"
      
      # Solar Power
      solar_power: !input solar_power_sensor
      solar_power_float: "{{ states(solar_power) | float(0) }}"
      
      # Konfiguration
      tolerance_int: !input tolerance
      regulator_factor_float: !input regulator_factor
      ki_factor_float: !input ki_factor
      offset_int: !input offset
      max_active_power_limit_int: !input max_active_power_limit
      pv_charge_reserve_int: !input pv_charge_reserve
      
      # PI-Regler-Variablen
      current_active_power: "{{ states(active_power_entity) | float(0) }}"
        
      # Max Power Limit in Zone 2 = Max(0, PV - Reserve)
      max_zone_2_limit: >
        {% set pv_minus_reserve = solar_power_float - pv_charge_reserve_int %}
        {% if pv_minus_reserve > 0 %}
          {{ pv_minus_reserve }}
        {% else %}
          0
        {% endif %}

      # Target Offset basiert auf Zone (0 W in Zone 1, Offset_Int in Zone 2)
      target_offset: >
        {% if is_state(cycle_active, 'on') %}
          0
        {% else %}
          {{ offset_int }}
        {% endif %}
      
      # ToleranzprÃ¼fung basiert auf tatsÃ¤chlichem Grid-Fehler (nicht begrenzt)
      grid_error_for_tolerance: "{{ (grid_power_float - target_offset) | abs }}"
      
      # Wartezeit
      wait_time_int: !input wait_time
      
     # PI-Regler Berechnung
      # 1. Aktueller Fehler 
      error: >
        {% if is_state(cycle_active, 'on') %}
          {# ZONE 1: Min(verfÃ¼gbare KapazitÃ¤t, Grid) #}
          {{ [(max_active_power_limit_int - current_active_power), grid_power_float] | min | float(0) }}
        {% else %}
          {# ZONE 2: Min(verfÃ¼gbare KapazitÃ¤t, Grid - Offset, PV-KapazitÃ¤t) #}
          {{ [(max_active_power_limit_int - current_active_power), (grid_power_float - offset_int), (max_zone_2_limit - current_active_power)] | min | float(0) }}
        {% endif %}
      
      # 2. Integral mit Anti-Windup
      integral_old: "{{ states(integral_entity) | float(0) }}"
      integral_new: >
        {% set error_float = error | float(0) %}
        {% if grid_error_for_tolerance > tolerance_int %}
          {{ [[-1000, integral_old + error_float] | max, 1000] | min | float(0) }}
        {% elif integral_old | abs > 10 %}
          {{ (integral_old * 0.95) | float(0) }}
        {% else %}
          {{ integral_old | float(0) }}
        {% endif %}
      
      # 3. PI-Korrektur (P-Anteil + I-Anteil)
      power_correction_pi: >
        {% set error_float = error | float(0) %}
        {% set integral_float = integral_new | float(0) %}
        {% set p_part = error_float * regulator_factor_float %}
        {% set i_part = integral_float * ki_factor_float %}
        {{ (p_part + i_part) | float(0) }}
      
      # 4. Neuer Power-Sollwert
      new_power_unlimited: >
        {% set correction = power_correction_pi | float(0) %}
        {{ (current_active_power + correction) | float(0) }}
        
      # 5. Finale Power: Logik in einem Template zusammengefasst
      final_power_calculated: >
        {% set p_regler_power = new_power_unlimited | float(0) %}
        {% if is_state(cycle_active, 'on') %}
          {# ZONE 1: Hard Limit #}
          {{ [max_active_power_limit_int, p_regler_power] | min | float(0) }}
        {% else %}
          {# ZONE 2: Dynamisches PV-Limit #}
          {% set max_zone_2 = max_zone_2_limit | float(0) %}
          {{ [max_zone_2, p_regler_power] | min | float(0) }}
        {% endif %}
        
  - choose:
      # FALL E.1: Limit fÃ¼r Zone 1 setzen (Aggressiv)
      - conditions:
          - condition: state
            entity_id: !input cycle_active_input_select
            state: 'on'
          - condition: template
            value_template: >
              {# PrÃ¼fe, ob der aktuelle Wert NICHT dem Maximalwert entspricht #}
              {{ states(discharge_current_entity) | float(999) | round(2) != discharge_current_max | float(0) | round(2) }}
        sequence:
          - service: number.set_value
            data:
              entity_id: !input max_discharge_current_number
              value: "{{ discharge_current_max }}"
              
      # FALL E.2: Limit fÃ¼r Zone 2 setzen (Batterieschonend = 0 A)
      - conditions:
          - condition: state
            entity_id: !input cycle_active_input_select
            state: 'off'
          - condition: template
            value_template: >
              {# PrÃ¼fe, ob der aktuelle Wert NICHT 0 A entspricht #}
              {{ states(discharge_current_entity) | float(999) | round(2) != 0 }}
        sequence:
          - service: number.set_value
            data:
              entity_id: !input max_discharge_current_number
              value: 0

  # 2. Timeout-Reset
  - choose: 
        # Timeout-Reset erforderlich
      - conditions:
          - condition: template
            value_template: "{{ states(timeout_countdown) | int(9999) < 120 }}"
        sequence:
          - service: number.set_value
            data:
              entity_id: !input remote_timeout_set_number
              value: 10
          - delay: '00:00:01'
          - service: number.set_value
            data:
              entity_id: !input remote_timeout_set_number
              value: 3599
              
  # 3. Integral speichern
  - service: input_number.set_value
    data:
      entity_id: !input integral_helper
      value: "{{ integral_new }}"
      
  # 4. Power Limit setzen (Nur wenn Toleranz Ã¼berschritten ist)
  - condition: template
    value_template: "{{ grid_error_for_tolerance > tolerance_int }}"
  
  - service: number.set_value
    data:
      entity_id: !input active_power_number
      value: "{{ [0, final_power_calculated] | max | round(0) }}"
  - delay:
      seconds: '{{wait_time_int}}'


